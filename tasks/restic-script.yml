---

- name: cronie
  package:
    name:
      - cronie
      - rclone

- name: cronie service
  service:
    name: crond
    state: started
    enabled: true

- name: restic repositories
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - "{{ restic_data_dir }}"
    - "{{ restic_data_dir }}/credentials"

- name: password file
  copy:
    dest: "{{ restic_password_file }}"
    content: |
      {{ restic_password }}
    mode: u=r,g=,o=

- name: restic script
  template:
    src: "{{ restic_script_template }}"
    dest: "{{ restic_bin_dir }}/{{ restic_name }}-restic"
    mode: u=rwx,g=rx,o=rx

- name: restic config
  template:
      src: restic.conf
      dest: "{{ restic_conf }}"
      mode: u=rwx,g=,o=

- name: rclone config
  copy:
      content:
        [swift]
        type = swift
        env_auth = true
      dest: "{{ rclone_conf }}"
      mode: u=rwx,g=,o=

- name: restic prune · script
  copy:
    dest: /usr/local/bin/restic-{{ restic_name }}-prune
    mode: ugo+x
    content: |
      #! /bin/bash
      source {{ restic_data_dir | quote }}/restic.conf
      restic prune

- name: restic check consistency · script
  copy:
    src: check-restic-consistency
    dest: /usr/local/bin/check-restic-consistency
    mode: ugo+x

- name: restic prune · cron
  when: restic_prune_crontab is defined
  copy:
    dest: /etc/cron.d/restic-{{ restic_name }}-prune
    mode: u=rw,g=r,o=r
    content: |
      MAILTO={{ restic_email_to | quote }}
      PATH=/usr/bin:/bin:/usr/sbin:/sbin:{{ restic_bin_dir | quote }}

      {{ restic_prune_crontab }} root /usr/local/bin/restic-{{ restic_name | quote }}-prune
